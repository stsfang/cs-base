

### 4、可靠传输

> TCP通过哪些方式保证可靠传输？

#### 4.1 超时重传

- 校验：

- 序列号 + 确认应答：

- 重传

  1）超时重传：发送数据的时候，设定一个定时器，当超过定时时间还没有收到ACK应答确认报文，就重传该数据。

  1. 超时时间`RTO`应该设为多少？`RTO`应该略大与一次数据的往返时间`RTT`，网络速度总是在变化的，所以`RTO`也是动态变化的。`TCP`通过不断采样`RTT`的时间来计算一个平滑的`RTT`值。
  2. 遇到一次超时重传之后，如果相同报文还超时，就将超时时间设置为先前`RTO`的两倍；如果2次都超时，说明网络环境很差，不适合频繁重复发送。

  2）快速重传（冗余`ACK`）：超时重传需要等待的时间间隔相对较长，如果想马上识别到需要重传，就使用快速重传。

#### 4.2 快速重传

> 什么是累积确认？

累积确认是指，在发送当前应答确认报文`Ak`之前，`A1  - Ak-1`都应该应答确认。

对`r1, r2, r3, r4, ...., r10` TCP请求报文序列，如果接收端收到`r1,r2,r4,r5,r6`,，没收到`r3`，那么先缓存`r4, r5, r6` 但是应答确认还是发送 `ACK(r3)`表示要去下个报文发送`r3`，或者表示接受端已收到`ACK(r3)`前的全部数据，要求开始发送`r3`。

#### 4.3 选择性重传

> 快速重传（冗余ACK）如何确定哪些TCP报文需要重传？

快速重传（冗余ACK）有一个问题：如收到`r3`的3个冗余ACK，那么下一步如何确定是只重传`r3`，还是重传`r3`及其后续的全部TCP报文。

为了解决这个问题，TCP协议引入了`SACK`字段，需要双方都打开支持`net.ipv4.tcp_sack`。

- SACK，Selective ACK，选择性应答，即可以选择只需要重传的TCP报文，而不需要全部重传；接收端在应答确认报文的`sack`字段指出接收端当前缓冲了哪些数据序列，同时结合【确认序列号】字段，以此告诉发送端哪些数据序列不需要重传，从而只重传丢失的数据。
- D-SACK，Duplicate SACK，D-SACK这种机制也是基于SACK字段，结合【确认序列号】字段，告诉发送端，接收端收到了哪些重复的报文数据。需要双方打开`net.ipv4.tcp_dsack`

【重点】接收方需要结合【ACK】确认序列号来确定当前`SACK`表示的是接收端的缓存序列，还是重复发送的报文序列。

### 5、滑动窗口

> 什么是滑动窗口？滑动窗口解决了什么问题？

TCP是每发送一个数据都需要接收方的应答确认，如果发送一个，确认应答一个，再发送下一个，再应答一个，显然效率是很低下的。为了解决这种效率低下的问题，引入滑动窗口，使得发送方一次能够发送多个，接收方一次能够接收多个，然后发送方和接收方都采取【累积确认】的模式。参见上面的【选择性重传】

- 发送窗口：发送端的发送窗口包括2部分的数据（槽）

  1. 已发送但未收到ACK确认的数据
  2. 未发送的但大小在接收方处理范围内的数据

  ![图片](.\image\sender_window.png)

- 接收窗口：接收窗口跟发送窗口不一样的，接收窗口是空的，等待发送窗口的数据发送过来

  1. 未收到数据但可以接收的数据空位
  2. 未收到数据并且还不可以结束的数据空位

  ![图片](.\image\receiver_window.png)

  > 滑动窗口的大小是如何确定的呢？

  TCP报文的头部有一个16比特的【窗口大小】的字段，【接收端】使用该字段告诉【发送端】自己还有多少接收缓冲区可以用于接收数据，从而调整【发送端】的发送窗口。

  所以滑动窗口的大小是由【接收方】决定的。

  > 接收窗口和发送窗口的大小是相等的吗？

  两者不总是大小相等的。因为接收窗口和发送窗口的调整是存在延迟的，如果接收方处理得很快的时候，接收窗口很快可以空出来的，将这个新的窗口大小发送给【发送方】之前，发送方的窗口大小跟接收方是不一样的。

  

### 6、流量控制

