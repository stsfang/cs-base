

### s1. HTTP报文生成（应用层）



### s2. 域名解析/DNS解析（应用层）

- 域名的层级关系

  （1）根DNS服务器：根DNS服务器的信息保存在所有的互联网DNS服务器中，所以其他DNS服务器都能找到根DNS服务器。

  （2）顶级DNS服务器

  （3）权威DNS服务器

- 域名解析 如www.xxxx.vivo.com

  Step 1：客户端请求本地DNS解析域名，如果本地DNS有缓存就知道返回域名对应的IP地址；否则，本地DNS就会去请求【根DNS】服务器

  Step 2：根DNS服务器收到本地DNS的请求，查看 www.xxxx.vivo.com，发现是.com这个顶级DNS服务器管理的，就把.com顶级DNS服务器的IP地址告诉本地DNS服务器。

  Step 3：本地DNS拿到.com顶级DNS服务器的IP地址后，就请求.com顶级DNS服务器；.com DNS服务器就把其下的vivo.com 权威DNS服务器的IP地址告诉本地DNS服务器。

  Step 4：本地DNS拿到vivo.com权威DNS服务器的IP地址后，请求vivo.com权威DNS服务器返返回xxxx.vivo.com的IP地址；权威DNS服务器告诉本地DNS服务器后，本地DNS服务器新建该域名对应的IP地址，作为缓存；然后将IP地址返回给客户端。



### s3. TCP和UDP（传输层）

- TCP协议

  （1）TCP报文格式：TCP报文头部 + TCP报文数据

  	- 源端口号、目的端口号：目标程序寻址
  	- 序列号：解决包乱序的问题
  	- 确认序列号：确认对方是否收到，没有收到就重发，解决不丢包的问题
  	- 状态位（SYN / ACK / RST / FIN ）
  	- 窗口大小：TCP做流量控制、拥塞控制

  

  （2）TCP连接的建立

  - TCP三次握手：保证对方都有发送和接收的能力，即准备好了相关的资源，建立连接。

  > netstat -napt 查看TCP连接状态；Recv-Q/Send-Q/Local Address/Foreign Address/State/PID
  >
  > 已经建立TCP连接的，Foreign Address会显示对方的【IP：Port】信息。一般来说，客户端的状态有如下：CLOSE  -> SYN_SENT -> ESTABLISHED -> TIME_WAIT -> CLOSE；服务端的状态有如下：CLOSE -> LISTEN -> SYN_RECV -> ESTABLISHED -> 

  

  （3）TCP数据分包

  - 如果HTTP报文负载超过TCP的MSS长度，那么TCP就会把HTTP报文进行分包，以MSS为单位，分别加上TCP的头部信息形成独立的TCP报文，然后交给IP层。

### s4. IP（网络层）

- IP协议

  （1）IP报文头部格式

  > IP包头部的协议号填的是TCP协议；
  >
  > 主机上的一个网卡对应一个IP地址，如果有多个网卡就有多个IP地址，这时候IP报文的源地址IP该如何选择呢？ 
  >
  > 那就要先看系统的路由表  route -n；系统的路由表配置了哪些范围的目标地址该选择哪个网卡。即，目的地址IP与掩码进行与运算，得到的目的地址IP匹配到Destination。
  >
  > 如果没有匹配到系统路由表中任何一项，就选择默认网关，即先发送给路由器，由路由器去决定。

  

- ICMP协议：报告网络数据包传输过程中产生的各种错误和控制信息

  > ICMP 互联网控制报文协议。确认IP包是否成功送到目的地址、报告发送过程中IP包被废弃的原因和改善网络设置等。所以TCMP报文有两种，一种是查询报文、一种是差错报文。
  >
  > 介于传输层和网络层之间，但是一般归为 网络层 协议。
  >
  > ping 就是基于IP/ICMP协议的，ping是一个应用工具。

  

- ARP协议：根据IP地址查询相应的以太网MAC地址

- MAC头部（注意MAC头部是IP层负责的，因为ARP工作在IP层）

  （1）MAC包头部：接收方和发送方的MAC地址。接收方未必是最终的接收方，在网络中，接收方泛指下一站，比如路由器。

>  为了获取接收方的MAC地址，就要用到对应的协议；而MAC包头部的协议类型只有 0800：IP协议 和 0806：ARP协议。

​		（2）ARP协议。

>  **在同一个子网下**，ARP协议通过广播的形式，查询IP地址对应的MAC地址，拿到MAC地址后，操作系统就会把本次结果缓存起来（缓存时间一般是几分钟）；广播只能在广播域中传播，路由器是可以隔离广播域的；
>
> 如果是在不同子网下？那就只能通过网关或者路由器，先获取默认网关的MAC地址；ARP广播报文的目的IP地址填写默认网关的IP地址，以此获取默认网关的MAC地址，然后把MAC包发给默认网关。
>
> 路由器收到数据包后，查看目的IP地址，发现不是自己，然后决定路由出去；接着查询路由表，准备转发到对应的路由器出口P0，发送之前当然也要确定目的MAC地址，如果路由器本地没有缓存目的MAC地址，同理，也要在路由器的P0端口的网段进行ARP广播，获取MAC地址。

### s5.物理层

- IP层获取填充MAC头部后形成的MAC包，发送到网卡，网卡加上报文和起始帧分界符合，末尾加上帧校验序列，然后将整个帧转换成电信号，通过网线发送出去。

- 交换机（二层网络设备，端口不具有MAC地址）：查询MAC地址表，决定这个包应该从交换机的哪个端口转发出去。MAC地址 ：交换机端口 ；如果没有查询到，那就简单粗暴地转发到其他所有端口（除了入口），只要收到响应包，交换机就能把MAC地址表缓存起来，下次就不用这么粗暴了。
- 路由器（基于IP设计，三层网络设备，端口有独立的MAC地址和IP地址）。网络包在路由之间传递，变化的一直是MAC地址信息，因为MAC地址信息是数据帧在以太网内两个设备之间包传输的基础。



